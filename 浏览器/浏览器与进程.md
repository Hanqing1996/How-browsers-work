#### 单进程浏览器时代（IE6）

![wWaCNR.png](https://s1.ax1x.com/2020/09/17/wWaCNR.png)

#### 组成

* 一个页面线程（单进程浏览器开多个页面，页面线程也只有一个）
* 一个网络线程
* 多个其它线程

#### 问题

1. 不安全

   > 插件可以获取到操作系统的任意资源，当你在页面运行一个插件时也就意味着这个插件能完全操作你的电脑。如果是个恶意插件，那么它就可以释放病毒、窃取你的账号密码，引发安全性问题。

2. 不稳定

   > 简单地说，就是某个页面的崩溃会导致整个浏览器的崩溃。

3. 内存泄漏

   > 通常浏览器的内核都是非常复杂的，运行一个复杂点的页面再关闭页面，会存在内存不能完全回收的情况，这样导致的问题是使用时间越长，内存占用越高，浏览器会变得越慢。

---

#### 早期多进程架构

![wWB1oQ.png](https://s1.ax1x.com/2020/09/17/wWB1oQ.png)

#### 组成

* 多个插件进程
* 多个渲染进程（每新开一个页面，就多一个渲染进程）
* 一个浏览器主进程

#### 如何解决单进程浏览器的问题

* 解决不安全的问题

  > 采用多进程架构的额外好处是可以使用安全沙箱，你可以把沙箱看成是操作系统给进程上了一把锁，沙箱里面的程序可以运行，但是不能在你的硬盘上写入任何数据，也不能在敏感位置读取任何数据，例如你的文档和桌面。Chrome 把插件进程和渲染进程锁在沙箱里面，这样即使在渲染进程或者插件进程里面执行了恶意程序，恶意程序也无法突破沙箱去获取系统权限。

  * 为什么 Chrome 会让渲染进程运行在安全沙箱里？

  渲染进程的主要职责是把从网络下载的 HTML、JavaScript、CSS、图片等资源解析为可以显示和交互的页面。**因为渲染进程所有的内容都是通过网络获取的，会存在一些恶意代码利用浏览器漏洞对系统进行攻击，所以运行在渲染进程里面的代码是不被信任的。**这也是为什么 Chrome 会让渲染进程运行在安全沙箱里，就是为了保证系统的安全。

  * 为什么单进程浏览器当时不可以采用安全沙箱？

  **沙箱的作用对象是进程**，如果一个进程使用了安全沙箱之后，该进程对于操作系统的权限就会受到限制，比如不能对一些位置的文件进行读写操作。**而单进程浏览器下，唯一的进程是浏览器主进程，它又是需要这些权限的（比如 `cookie`数据要放到磁盘上）**！所以安全沙箱是不能应用到浏览器主进程之上的。

* 解决不稳定的问题

  > 由于进程是相互隔离的，所以当一个页面或者插件崩溃时，影响到的仅仅是当前的页面进程或者插件进程，并不会影响到浏览器和其他页面，这就完美地解决了页面或者插件的崩溃会导致整个浏览器崩溃，也就是不稳定的问题。

* 内存泄漏的问题

  > 当关闭一个页面时，整个渲染进程也会被关闭，之后该进程所占用的内存都会被系统回收

---

#### 目前多进程架构

![wW5cLQ.png](https://s1.ax1x.com/2020/09/17/wW5cLQ.png)

#### 组成

* 多个插件进程

  > 主要是负责插件的运行，**因插件易崩溃，所以需要通过插件进程来隔离**，以保证插件进程崩溃不会对浏览器和页面造成影响。

* 多个渲染进程（每新开一个页面，就多一个渲染进程）

  > 核心任务是将 HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，排版引擎 `Blink` 和 `JavaScript` 引擎 `V8` 都是运行在该进程中，默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在沙箱模式下。

* 一个浏览器主进程

  >  主要负责界面显示、用户交互、子进程管理，同时提供存储等功能。

* 一个网络进程

  > 主要负责页面的网络资源加载，之前是作为一个模块运行在浏览器进程里面的，直至最近才独立出来，成为一个单独的进程。

* 一个GPU进程

  > 其实，Chrome 刚开始发布的时候是没有 GPU 进程的。而 GPU 的使用初衷是为了实现 3D CSS 的效果，只是随后网页、Chrome 的 UI 界面都选择采用 GPU 来绘制，这使得 GPU 成为浏览器普遍的需求。最后，Chrome 在其多进程架构上也引入了 GPU 进程。

---

#### 打开一个页面至少要几个进程？

打开 1 个页面至少需要 1 个网络进程、1 个浏览器进程、1 个 GPU 进程以及 1 个渲染进程，共 4 个；如果打开的页面有运行插件的话，还需要再加上 1 个插件进程。

#### 同一站点(same-site)

通常情况下是一个页面使用一个进程，但是，有一种情况，叫"同一站点(same-site)"，**具体地讲，我们将“同一站点”定义为根域名（例如，geekbang.org）加上协议（例如，https:// 或者http://），比如下面这三个：

```javascript
https://time.geekbang.org
https://www.geekbang.org
https://www.geekbang.org:8080
```

都是属于同一站点，因为它们的协议都是`https`，而根域名也都是`geekbang.org`。你也许了解同源策略，但是同一站点和[同源策略]([https://github.com/Hanqing1996/cross-domain-learning#%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5](https://github.com/Hanqing1996/cross-domain-learning#浏览器的同源策略))还是存在一些不同地方。

**直白的讲，就是如果几个页面符合同一站点，那么他们将被分配到一个渲染进程里面去。**

所以，这种情况下，一个页面崩溃了，会导致同一站点的页面同时崩溃，因为他们使用了同一个渲染进程。

为什么要让他们跑在一个进程里面呢？

**因为在一个渲染进程里面，他们就会共享JS的执行环境**，也就是说A页面可以直接在B页面中执行脚本。因为是同一家的站点，所以是有这个需求的。

---

#### UserAgent

又称为UA，UA是浏览器的身份证，通常，在发送HTTP请求时，UA会附带在HTTP的请求头中user-agent字段中，这样服务器就会知道浏览器的基础信息，然后服务器会根据不同的UA返回不同的页面内容，比如手机上返回手机的样式，PC就返回PC的样式。



我们也可以在浏览器的控制台中输入：

```javascript
navigator.userAgent
```

来查看当前浏览器的UA信息。



FireFox中的打印的信息是：

> "Mozilla/5.0 (Macintosh; Intel Mac  OS X 10.14; rv:68.0) Gecko/20100101 Firefox/68.0"

Chrome中打印的信息是：

> "Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Mobile Safari/537.36"

安卓系统中的Chrome浏览器：

> "Mozilla/5.0 (Linux; Android 5.0; SM-G900P Build/LRX21T) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Mobile Safari/537.36"



**为啥上面的浏览器`UA`都带有 Mozilla 呢？**

服务器会根据不同的UA来针性的设计不同页面，所以当出了一款新浏览器时，他如果使用自己独一无二的UA，那么之前的很多服务器还需要针对他来做页面适配，这显然是不可能的，比如Chrome发布时他会在他的UA中使用“Mozilla” ，“AppleWebKit”，等关键字段，用来表示他同时支持Mozilla和AppleWebKit，然后再在最后加上他自己的标示，如Chrome/xxx。



所以说，**通过UA判断浏览器的类型是不准的！**

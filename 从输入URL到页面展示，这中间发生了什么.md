#### 从输入URL到页面展示，这中间发生了什么？![Alt](https://i.loli.net/2020/09/18/bfiIJWGHa3zs9Nk.jpg)

1、用户输入关键词，地址栏判断是搜索内容还是url地址。
如果是搜索内容，会使用浏览器默认搜索引擎加上搜索内容合成url；
如果是域名会加上协议（如https）合成完整的url。

2、然后按下回车。

当用户输入关键字并键入回车之后，这意味着当前页面即将要被替换成新的页面，**不过在这个流程继续之前，浏览器还给了当前页面一次执行 beforeunload 事件的机会，beforeunload 事件允许页面在退出之前执行一些数据清理操作，还可以询问用户是否要离开当前页面，比如当前页面可能有未提交完成的表单等情况，因此用户可以通过 beforeunload 事件来取消导航，让浏览器不再执行任何后续工作。**当前页面没有监听 beforeunload 事件或者同意了继续后续流程，那么浏览器便进入下图的状态：

![wInPMj.png](https://s1.ax1x.com/2020/09/19/wInPMj.png)



从图中可以看出，当浏览器刚开始加载一个地址之后，标签页上的图标便进入了加载状态。**但此时图中页面显示的依然是之前打开的页面内容，并没立即替换为极客时间的页面。因为需要等待提交文档阶段，页面内容才会被替换。**



浏览器进程通过IPC（进程间通信）把url传给网络进程（网络进程接收到url才发起真正的网络请求）。

3、网络进程接收到url后，先查找有没有缓存。
有缓存，直接返回缓存的资源。
没有缓存。（进入真正的网络请求）。首先获取域名的IP，系统会首先自动从hosts文件中寻找域名对应的 IP 地址，一旦找到，和服务器建立TCP连接；如果没有找到，则系统会将网址提交 DNS 域名解析服务器进行 IP 地址的解析。

4、利用IP地址和服务器建立TCP连接（3次握手）。

5、建立连接后，浏览器构建数据包（包含请求行，请求头，请求正文，并把该域名相关Cookie等数据附加到请求头），然后向服务器发送请求消息。

6、服务器接收到消息后根据请求信息构建响应数据（包括响应行，响应头，响应正文），然后发送回网络进程。

7、**网络进程接收到响应数据后进行解析。**
如果发现响应行的返回的状态码为301，302，说明服务器要我们去找别人要数据，找谁呢？找响应头中的Location字段要，Location的内容是需要重定向的地址url。获取到这个url一切重新来过。
如果返回的状态码为200，说明服务器返回了数据。

8、好了，获取到数据以什么方式打开呢？打开的方式不对的话也不行。打开的方式就是 Content-Type。这个属性告诉浏览器服务器返回的数据是什么类型的。如果返回的是网页类型则为 text/html，如果是下载文件类型则为 application/octet-stream 等等。打开的方式不对，则得到的结果也不对。 
如果是下载类型，则该请求会被提交给浏览器的下载管理器，同时该请求的流程到此结束。
如果是网页类型，那么浏览器就要准备渲染页面了（**准备渲染进程**）。

9、浏览器进程接收到网络进程的响应头数据之后，发送“提交导航 (CommitNavigation)”消息到渲染进程；

10、渲染进程接收到“提交导航”的消息之后，便开始准备接收 HTML 数据，接收数据的方式是直接和网络进程建立数据管道；

11、HTML等数据传输完毕，**渲染进程会发出“确认提交”消息给浏览器进程**。浏览器在接收到“确认提交”消息后，更新浏览器界面状态（包括地址栏信息，仟前进后退历史，web页面和网站安全状态）。**注意这里是开始更新，由于接下来渲染进程还要做资源的解析（蔬菜来了，但是厨师还没开始做），这个更新会持续一段时间**



![wInaSe.png](https://s1.ax1x.com/2020/09/19/wInaSe.png)

12、渲染进程开始页面解析和子资源加载，

一旦页面生成完成，渲染进程会发送一个消息给浏览器进程，浏览器接收到消息后，会停止标签图标上的加载动画。如下所示：

![wInhOs.png](https://s1.ax1x.com/2020/09/19/wInhOs.png)

---

#### 为什么在浏览器的地址栏里面输入了一个地址并回车后，之前的页面没有立马消失，而是要加载一会儿才会更新页面？

简单来说，页面更新是在“确认提交”阶段，与输入并回车有一定的时间差。注意这里的更新也不是一时半刻就能完成的，要等待渲染进程的完成。

---

#### 提交文档后向浏览器确认提交，这个时候更新的web页面只是一个空白页面吗？ 等页面渲染阶段完成后才会展示解析内容吗？

是的，提交文档后便开始解析DOM，解析CSS，生成布局树，然后绘制等操作，从解析HTML到绘制页面的第一个像素，是需要时间的！

优化好的页面这个时间会很短，优化差的页面这个空白时间会比较久！
